<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Panel de usuario con estadÃ­sticas, recordatorios y gestiÃ³n mÃ©dica para mejorar el seguimiento de tratamientos.">
    <title>Panel de Usuario</title>
    <link rel="shortcut icon" th:href="@{/media/favicon_IA_Medica.ico}" type="image/x-icon">
    <link rel="stylesheet" th:href="@{/css/style2.css}" type="text/css">

</head>
<body>
<section class="contenedor">
    <div th:replace="~{fragments/header :: header}"></div>

    <main id="main_panelUser">

        <section class="section_main" sec:authorize="hasRole('USER')" data-role="user">
            <section class="section_panelUser">
                <nav class="nav_panelUser">
                    <ul>
                        <li><a href="/pedirCita" title="Ver estadÃ­sticas de usuario">Citas</a></li>
                        <li><a th:href="@{/usuarios/registroSintomas}">Sintomas</a></li>
                        <li><a href="/tratamientos" title="Ver tratamientos">Tratamientos</a></li>
                        <li><a th:href="@{/usuarios/recordatorios}" title="Ver recordatorios">Recordatorios</a></li>
                        <li><a href="/estadisticasUsuario" title="Ver estadÃ­sticas de usuario">EstadÃ­sticas</a></li>
                        <li><a th:href="@{/usuarios/historialPaciente}">Historial</a></li>
                        <li><a th:href="@{/docs}" title="Ver documentaciÃ³n" class="menu" target="_blank">DocumentaciÃ³n</a></li>
                        <li><a href="/usuarios/configUsuario" title="ConfiguraciÃ³n de usuario">ConfiguraciÃ³n</a></li>
                    </ul>
                </nav>
            </section>
            <section>
                <form th:action="@{/logout}" method="post" class="logout-form">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button type="submit" class="btn-logout">
                        â‹ Salir
                    </button>
                </form>
            </section>
            <section class="dashboard-overview" id="panel-usuario" th:with="p=${panel}">
                <div class="card">
                    <h3>ğŸ“Š EstadÃ­sticas</h3>
                    <p>ğŸ“‰ EvoluciÃ³n de sÃ­ntomas</p>

                    <p>
                        ğŸ“Š Progreso del tratamiento
                        <span id="trat-activos" class="mini"
                              th:text="${p != null and p.tratamientosEnCurso != null} ? '(' + p.tratamientosEnCurso + ' activos)' : ''">
        <!-- fallback -->
      </span>
                    </p>

                    <p>
                        âœ… Adherencia al tratamiento
                        <span id="adh-porc" class="mini"
                              th:text="${p != null and p.adherenciaPorc != null} ? ${#numbers.formatInteger(p.adherenciaPorc,0)} + '%' : '0%'">
        0%
      </span>
                    </p>
                </div>

                <div class="card">
                    <h3>ğŸ“„ Historial MÃ©dico</h3>
                    <p>
                        ğŸ“… Citas pasadas y diagnÃ³sticos
                        <span id="citas-pasadas" class="mini"
                              th:text="${p != null and p.citasPasadas != null} ? '(' + p.citasPasadas + ')' : ''"></span>
                    </p>
                    <p>
                        ğŸ“‚ Descarga de informes
                        <span class="mini"
                              th:text="${p != null and p.informes != null} ? '(' + p.informes + ')' : ''"></span>
                    </p>
                </div>

                <div class="card">
                    <h3>â° Recordatorios</h3>
                    <p>
                        ğŸ”” PrÃ³ximos medicamentos
                        <span id="prox-med" class="mini"
                              th:text="${p != null and p.proximoMedicamento != null} ?
                     'â€” ' + p.proximoMedicamento + (p.proximaDosisHoraFmt != null ? ' Â· ' + p.proximaDosisHoraFmt : '') : 'â€”'">
        â€”
      </span>
                    </p>
                    <p>
                        ğŸ¥ PrÃ³xima cita
                        <span id="prox-cita" class="mini"
                              th:text="${p != null and p.proximaCitaFmt != null} ? p.proximaCitaFmt : 'â€”'">â€”</span>
                    </p>
                    <p>
                        âš ï¸ Alertas de dosis olvidadas
                        <span id="alertas-dosis" class="mini"
                              th:text="${p != null and p.alertasDosis != null and p.alertasDosis > 0} ? '(' + p.alertasDosis + ')' : ''"></span>
                    </p>
                </div>

                <div class="card">
                    <h3>ğŸ“© Mensajes</h3>
                    <p>
                        ğŸ’¬ Mensajes sin leer
                        <span id="msgs-unread" class="pill pill--info"
                              th:text="${p != null and p.unread != null} ? p.unread : 0">0</span>
                    </p>
                    <p>
                        ğŸ”” Notificaciones recientes
                        <span class="pill pill--muted"
                              th:text="${p != null and p.notifs != null} ? p.notifs : 0">0</span>
                    </p>
                </div>

                <div class="card">
                    <h3>âš™ï¸ ConfiguraciÃ³n</h3>
                    <p>
                        ğŸ‘¤ Editar perfil
                        <span class="pill pill--warn"
                              th:if="${p != null and p.perfilCompleto != null and !p.perfilCompleto}">
        incompleto
      </span>
                    </p>
                    <p>ğŸ”§ Ajustes de notificaciones</p>
                </div>

                <div class="card">
                    <h3>ğŸ¤– Asistente</h3>
                    <p>ğŸ—£ï¸ Consultar</p>
                    <p>ğŸ”§ ConfiguraciÃ³n</p>
                </div>
            </section>
            <!-- BotÃ³n flotante -->
            <div id="chat-toggle"  onclick="toggleChatById('chat-box')">ğŸ’¬</div>
            <!-- Ventana de chat -->
            <div id="chat-box">
                <div id="chat-header">Asistente Virtual <span onclick="toggleChat()">X</span></div>
                <div id="chat-body">
                    <p><strong>Asistente:</strong> Â¡Hola! Â¿En quÃ© puedo ayudarte?</p>
                    <div id="chat-messages"></div>
                    <input type="text" id="chat-input" placeholder="Escribe tu mensaje aquÃ­..." />
                </div>
            </div>
        </section>

        <section class="section_main" sec:authorize="hasRole('ADMIN')" data-role="admin">
            <section class="section_panelUser">
                <nav class="nav_panelUser">
                    <ul>
                        <li><a th:href="@{/admin/usuarios}">Usuarios</a></li>
                        <li><a th:href="@{/admin/tratamientos}">Tratamientos</a></li>
                        <li><a th:href="@{/admin/citas}">Citas</a></li>
                        <li><a th:href="@{/admin/estadisticas}">Reportes</a></li>
                        <li><a th:href="@{/admin/chat}">Mensajes</a></li>
                        <li><a th:href="@{/admin/config}">ConfiguraciÃ³n</a></li>
                    </ul>
                </nav>
            </section>

            <section>
                <form th:action="@{/logout}" method="post" class="logout-form">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button type="submit" class="btn-logout">â‹ Salir</button>
                </form>
            </section>

            <!-- === Panel principal de administraciÃ³n === -->
            <section class="dashboard-overview" id="panel-admin" th:with="a=${adminPanel}">

                <div class="card">
                    <h3>ğŸ‘¥ GestiÃ³n de Usuarios</h3>
                    <p>ğŸ“‹ Usuarios registrados
                        <span id="admin-usuarios" class="mini"
                              th:text="${a != null and a.totalUsuarios != null} ? '(' + a.totalUsuarios + ')' : '(0)'">(0)</span>
                    </p>
                    <p>ğŸŸ¢ Activos
                        <span id="admin-activos" class="pill pill--info"
                              th:text="${a != null and a.usuariosActivos != null} ? a.usuariosActivos : 0">0</span>
                        &nbsp; ğŸ”´ Inactivos
                        <span id="admin-inactivos" class="pill pill--warn"
                              th:text="${a != null and a.usuariosInactivos != null} ? a.usuariosInactivos : 0">0</span>
                    </p>
                </div>

                <div class="card">
                    <h3>ğŸ©º GestiÃ³n de Tratamientos</h3>
                    <p>ğŸ“„ Tratamientos activos
                        <span id="admin-trat-activos" class="mini"
                              th:text="${a != null and a.tratActivos != null} ? '(' + a.tratActivos + ')' : '(â€”)'">(â€”)</span>
                    </p>
                    <p>â³ En revisiÃ³n
                        <span id="admin-trat-revision" class="pill pill--muted"
                              th:text="${a != null and a.tratRevision != null} ? a.tratRevision : 0">0</span>
                    </p>
                </div>

                <div class="card">
                    <h3>ğŸ“… Agenda y Citas</h3>
                    <p>ğŸ“† Citas totales
                        <span id="admin-citas" class="mini"
                              th:text="${a != null and a.citasTotales != null} ? '(' + a.citasTotales + ')' : '(â€”)'">(â€”)</span>
                    </p>
                    <p>ğŸ•’ PrÃ³ximas 24h
                        <span id="admin-citas-hoy" class="pill pill--info"
                              th:text="${a != null and a.citasHoy != null} ? a.citasHoy : 0">0</span>
                    </p>
                </div>

                <div class="card">
                    <h3>ğŸ“ˆ EstadÃ­sticas Globales</h3>
                    <p>ğŸ“Š Reportes generados
                        <span id="admin-reportes" class="mini"
                              th:text="${a != null and a.reportesGenerados != null} ? '(' + a.reportesGenerados + ')' : '(â€”)'">(â€”)</span>
                    </p>
                    <p>ğŸ§© Ãreas monitoreadas
                        <span id="admin-areas" class="pill pill--muted"
                              th:text="${a != null and a.areasMonitoreadas != null} ? a.areasMonitoreadas : 0">0</span>
                    </p>
                </div>

                <div class="card">
                    <h3>ğŸ“¬ Sistema de MensajerÃ­a</h3>
                    <p>ğŸ’¬ Mensajes sin leer
                        <span id="admin-msgs" class="pill pill--info"
                              th:text="${a != null and a.mensajesPendientes != null} ? a.mensajesPendientes : 0">0</span>
                    </p>
                    <p>ğŸ”” Notificaciones enviadas
                        <span id="admin-notifs" class="pill pill--muted"
                              th:text="${a != null and a.notifs != null} ? a.notifs : 0">0</span>
                    </p>
                </div>

                <div class="card wide-card">
                    <h3>ğŸ› ï¸ Configuraciones Generales</h3>
                    <p>âš™ï¸ ParÃ¡metros del sistema
                        <span id="admin-configs" class="mini"
                              th:text="${a != null and a.configsTotales != null} ? '(' + a.configsTotales + ')' : '(â€”)'">(â€”)</span>
                    </p>
                    <p>ğŸ§¾ Ãšltima actualizaciÃ³n
                        <span id="admin-update" class="mini"
                              th:text="${a != null and a.ultimaActualizacion != null} ? a.ultimaActualizacion : 'â€”'">â€”</span>
                    </p>
                </div>

            </section>

            <!-- Chat flotante -->
            <div id="chat-toggle2" onclick="toggleChatById('chat-box2')">ğŸ’¬</div>

            <div id="chat-box2">
                <div id="chat-header2">Asistente Virtual <span onclick="toggleChat()">X</span></div>
                <div id="chat-body2">
                    <p><strong>Asistente:</strong> Â¡Hola! Â¿En quÃ© puedo ayudarte?</p>
                    <div id="chat-messages2"></div>
                    <input type="text" id="chat-input2" placeholder="Escribe tu mensaje aquÃ­..." />
                </div>
            </div>
        </section>

        <section class="section_main" sec:authorize="hasRole('MEDICO')" data-role="medico">
            <section class="section_panelUser">
                <nav class="nav_panelUser">
                    <ul>
                        <li><a th:href="@{/medico/pacientes}">Pacientes</a></li>
                        <li><a th:href="@{/medico/citas}">Citas</a></li>
                        <li><a th:href="@{/medico/tratamientos}">Tratamientos</a></li>
                        <li><a th:href="@{/medico/sintomas}">SÃ­ntomas</a></li>
                        <li><a th:href="@{/medico/chat}">Mensajes</a></li>
                        <li><a th:href="@{/medico/configMedico}">ConfiguraciÃ³n</a></li>
                    </ul>
                </nav>
            </section>

            <section>
                <form th:action="@{/logout}" method="post" class="logout-form">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button type="submit" class="btn-logout">â‹ Salir</button>
                </form>
            </section>

            <!-- === Panel principal del mÃ©dico === -->
            <section class="dashboard-overview" id="panel-medico" th:with="m=${medicoPanel}">

                <div class="card">
                    <h3>ğŸ‘¥ Pacientes Vinculados</h3>
                    <p>ğŸ§‘â€âš•ï¸ Total de pacientes
                        <span id="med-pacientes-total" class="mini"
                              th:text="${m != null and m.totalPacientes != null} ? '(' + m.totalPacientes + ')' : '(â€”)'">(â€”)</span>
                    </p>
                    <p>âœ… Pacientes activos
                        <span id="med-pacientes-activos" class="pill pill--info"
                              th:text="${m != null and m.pacientesActivos != null} ? m.pacientesActivos : 0">0</span>
                    </p>
                </div>

                <div class="card">
                    <h3>ğŸ“… Citas Programadas</h3>
                    <p>ğŸ“† Citas de hoy
                        <span id="med-citas-hoy" class="mini"
                              th:text="${m != null and m.citasHoy != null} ? '(' + m.citasHoy + ')' : '(â€”)'">(â€”)</span>
                    </p>
                    <p>ğŸ•’ PrÃ³xima cita
                        <span id="med-prox-cita" class="pill pill--muted"
                              th:text="${m != null and m.proximaCita != null} ? m.proximaCita : 'â€”'">â€”</span>
                    </p>
                </div>

                <div class="card">
                    <h3>ğŸ“ˆ Registro de Tratamientos</h3>
                    <p>ğŸ’Š Tratamientos activos
                        <span id="med-trat-activos" class="mini"
                              th:text="${m != null and m.tratActivos != null} ? '(' + m.tratActivos + ')' : '(â€”)'">(â€”)</span>
                    </p>
                    <p>â³ En seguimiento
                        <span id="med-trat-seguimiento" class="pill pill--info"
                              th:text="${m != null and m.tratSeguimiento != null} ? m.tratSeguimiento : 0">0</span>
                    </p>
                </div>

                <div class="card">
                    <h3>ğŸ§¾ Reportes SintomÃ¡ticos</h3>
                    <p>ğŸ“‹ Reportes recientes
                        <span id="med-reportes" class="mini"
                              th:text="${m != null and m.reportesRecientes != null} ? '(' + m.reportesRecientes + ')' : '(â€”)'">(â€”)</span>
                    </p>
                    <p>âš ï¸ Alertas detectadas
                        <span id="med-alertas" class="pill pill--warn"
                              th:text="${m != null and m.alertasDetectadas != null} ? m.alertasDetectadas : 0">0</span>
                    </p>
                </div>

                <div class="card">
                    <h3>ğŸ“¬ MensajerÃ­a con Pacientes</h3>
                    <p>ğŸ’¬ Mensajes pendientes
                        <span id="med-msgs" class="pill pill--info"
                              th:text="${m != null and m.mensajesPendientes != null} ? m.mensajesPendientes : 0">0</span>
                    </p>
                    <p>ğŸ”” Notificaciones enviadas
                        <span id="med-notifs" class="pill pill--muted"
                              th:text="${m != null and m.notifs != null} ? m.notifs : 0">0</span>
                    </p>
                </div>

                <div class="card wide-card">
                    <h3>ğŸ› ï¸ ConfiguraciÃ³n del MÃ©dico</h3>
                    <p>âš™ï¸ Preferencias guardadas
                        <span id="med-configs" class="mini"
                              th:text="${m != null and m.configsTotales != null} ? '(' + m.configsTotales + ')' : '(â€”)'">(â€”)</span>
                    </p>
                    <p>ğŸ§¾ Ãšltima actualizaciÃ³n
                        <span id="med-update" class="mini"
                              th:text="${m != null and m.ultimaActualizacion != null} ? m.ultimaActualizacion : 'â€”'">â€”</span>
                    </p>
                </div>

            </section>

            <!-- Chat flotante -->
            <div id="chat-toggle3" onclick="toggleChatById('chat-box3')">ğŸ’¬</div>
            <div id="chat-box3">
                <div id="chat-header3">Asistente Virtual <span onclick="toggleChat()">X</span></div>
                <div id="chat-body3">
                    <p><strong>Asistente:</strong> Â¡Hola! Â¿En quÃ© puedo ayudarte?</p>
                    <div id="chat-messages3"></div>
                    <input type="text" id="chat-input3" placeholder="Escribe tu mensaje aquÃ­..." />
                </div>
            </div>
        </section>

    </main>
    <div th:replace="~{fragments/footer :: footer}"></div>
</section>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const el = document.getElementById('ID');
        if (!el) return;
        el.addEventListener('click', handler);
    });
</script>
<script>
    function toggleChatById(id){
        const el = document.getElementById(id);
        if (el) el.classList.toggle("open");
    }
</script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const root = document.getElementById("panel-usuario");
        if (!root) return;
        const $ = s => document.querySelector(s);

        const $tratActivos = $("#trat-activos");
        const $adh         = $("#adh-porc");
        const $citasPast   = $("#citas-pasadas");
        const $proxMed     = $("#prox-med");
        const $proxCita    = $("#prox-cita");
        const $alertas     = $("#alertas-dosis");
        const $unread      = $("#msgs-unread");

        fetch("/api/panel/overview", { headers: { "Accept": "application/json" }})
            .then(r => r.ok ? r.json() : Promise.reject(r))
            .then(p => {
                if ($tratActivos) $tratActivos.textContent =
                    (p.tratamientosEnCurso ?? 0) > 0 ? `(${p.tratamientosEnCurso} activos)` : "";

                if ($adh) $adh.textContent = ((p.adherenciaPorc ?? 0) | 0) + "%";

                if ($citasPast) $citasPast.textContent = `(${p.citasPasadas ?? 0})`;

                if ($proxMed) {
                    const med  = p.proximoMedicamento;
                    const hora = p.proximaDosisHoraFmt;
                    $proxMed.textContent = med ? `â€” ${med}${hora ? " Â· " + hora : ""}` : "â€”";
                }

                if ($proxCita) $proxCita.textContent = p.proximaCitaFmt ?? "â€”";

                if ($alertas) $alertas.textContent =
                    (p.alertasDosis ?? 0) > 0 ? `(${p.alertasDosis})` : "";

                if ($unread) $unread.textContent = p.unread ?? 0;
            })
            .catch(() => {/* deja el SSR de Thymeleaf */});
    });
</script>
<script th:src="@{/js/panelUsuario.js}" src="/js/panelUsuario.js"></script>
<script th:src="@{/js/darkTheme.js}" src="/js/darkTheme.js"></script>
<script th:src="@{/js/asistentes-panel.js}" src="/js/asistentes-panel.js"></script>
<script th:src="@{/js/sccript.js}" src="/js/sccript.js"></script>
</body>
</html>