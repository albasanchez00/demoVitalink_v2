<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chat interno</title>
    <link rel="stylesheet" href="/css/style2.css">
    <link rel="shortcut icon" th:href="@{/media/favicon_IA_Medica.ico}" type="image/x-icon">
</head>
<body class="body-msg" th:data-user="${#authentication.name}">
<div th:replace="~{fragments/header :: header}"></div>

<section id="chat-wrap">
    <aside id="chat-list">
        <div class="chatv2__sidehead">
            <h3>Mensajer√≠a</h3>
            <span class="pill pill--danger" id="totalUnread" style="display:none">0</span>
        </div>

        <div class="crear-conv">
            <div class="crear-conv__form">
                <input id="nuevo-usuario" type="text" placeholder="Buscar o crear conversaci√≥n...">
                <button id="btn-crear" type="button">Nueva</button>
            </div>
            <small class="crear-conv__help">Escribe el username del usuario</small>
        </div>

        <ul id="listaConversaciones" class="chat-list">
            <li class="empty-state">Cargando conversaciones...</li>
        </ul>
    </aside>

    <main id="chat-panel">
        <header class="chatv2__head">
            <button class="back-btn" type="button" aria-label="Volver">‚Üê</button>
            <div class="title">
                <strong id="convTitle">Selecciona una conversaci√≥n</strong>
                <span class="status">
                    <span class="dot"></span>
                    <span id="statusText">en l√≠nea</span>
                </span>
            </div>
            <div class="actions">
                <button class="ghost" id="search-btn" title="Buscar">üîç</button>
                <button class="ghost" id="options-btn" title="Opciones">‚ãØ</button>

                <!-- Men√∫ de opciones -->
                <div id="options-menu">
                    <div class="menu-item" id="mute-conv">
                        <span class="menu-icon">üîï</span>
                        <span>Silenciar</span>
                    </div>
                    <div class="menu-item" id="archive-conv">
                        <span class="menu-icon">üìÅ</span>
                        <span>Archivar</span>
                    </div>
                    <div class="menu-item" id="details-conv">
                        <span class="menu-icon">‚ÑπÔ∏è</span>
                        <span>Ver detalles</span>
                    </div>
                    <div class="menu-item" id="clear-history">
                        <span class="menu-icon">üóëÔ∏è</span>
                        <span>Limpiar historial</span>
                    </div>
                    <div class="menu-item danger" id="delete-conv">
                        <span class="menu-icon">‚ùå</span>
                        <span>Eliminar conversaci√≥n</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Barra de b√∫squeda -->
        <div id="search-bar">
            <input type="text" id="search-input" placeholder="Buscar en la conversaci√≥n...">
            <span id="search-results">0 resultados</span>
            <button class="search-nav-btn" id="prev-result" disabled>‚Üë</button>
            <button class="search-nav-btn" id="next-result" disabled>‚Üì</button>
            <button id="close-search">‚úï</button>
        </div>

        <div id="mensajes" class="chatv2__messages">
            <div class="empty-state">Selecciona una conversaci√≥n para empezar</div>
        </div>

        <form id="form-msg" class="chatv2__composer" autocomplete="off">
            <textarea id="txt" rows="1" placeholder="Escribe un mensaje..."></textarea>
            <button type="submit" class="send">Enviar</button>
        </form>
    </main>
</section>

<div th:replace="~{fragments/footer :: footer}"></div>

<script defer src="/webjars/sockjs-client/sockjs.min.js"></script>
<script defer src="/webjars/stomp-websocket/stomp.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', function () {
        initChat();
    });

    function initChat(){
        const yo = document.body.dataset.user || '';
        let stomp = null;
        let currentConvId = null;
        let currentSubscription = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT = 10;

        // ===== ESTADO DE B√öSQUEDA =====
        let searchResults = [];
        let currentSearchIndex = -1;

        const $lista = () => document.getElementById('listaConversaciones');
        const $msgs  = () => document.getElementById('mensajes');
        const $title = () => document.getElementById('convTitle');
        const $totalUnread = () => document.getElementById('totalUnread');
        const $searchBar = () => document.getElementById('search-bar');
        const $searchInput = () => document.getElementById('search-input');
        const $searchResults = () => document.getElementById('search-results');
        const $optionsMenu = () => document.getElementById('options-menu');

        function renderEmptyMensajes(texto){
            $msgs().innerHTML = '<div class="empty-state">' + escapeHTML(texto) + '</div>';
        }

        function escapeHTML(s){
            return String(s).replace(/[&<>"']/g, function(c){
                return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]);
            });
        }

        function fetchJSON(url, options){
            return fetch(url, options).then(function(resp){
                if (resp.status === 401) { window.location.href = '/inicioSesion'; throw new Error('401'); }
                if (resp.status === 403) { alert('No tienes permiso.'); throw new Error('403'); }
                if (!resp.ok) { throw new Error('HTTP ' + resp.status); }
                return resp.json();
            });
        }

        function conectarChat() {
            const sock = new SockJS('/ws-chat');
            stomp = Stomp.over(sock);
            stomp.debug = () => {};

            stomp.connect({}, function () {
                console.log('‚úÖ Conectado');
                reconnectAttempts = 0;
                if (currentConvId) {
                    suscribirA(currentConvId);
                }
            }, function (err) {
                console.warn('‚ö†Ô∏è Reintentando...', err);
                if (reconnectAttempts < MAX_RECONNECT) {
                    reconnectAttempts++;
                    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                    setTimeout(conectarChat, delay);
                }
            });

            sock.onclose = () => {
                console.warn('üîå Desconectado, reconectando...');
                if (reconnectAttempts < MAX_RECONNECT) setTimeout(conectarChat, 3000);
            };
        }

        function cargarConversaciones() {
            fetchJSON('/api/chat/conversaciones').then(function(data){
                const ul = $lista();
                ul.innerHTML = '';

                if (!data || !data.length){
                    ul.innerHTML = '<li class="empty-state">No tienes conversaciones</li>';
                    renderEmptyMensajes('Crea una conversaci√≥n para empezar');
                    actualizarContadorGlobal(0);
                    return;
                }

                let totalUnread = 0;

                data.forEach(function(c){
                    const li = document.createElement('li');
                    li.dataset.id = c.id;

                    const titulo = c.servicio ? escapeHTML(c.servicio) : ('Conversaci√≥n #' + c.id);
                    const unreadBadge = c.unreadCount > 0
                        ? '<span class="unread-badge">' + c.unreadCount + '</span>'
                        : '';

                    totalUnread += c.unreadCount || 0;

                    li.innerHTML = `
                        <div class="conv-item ${c.unreadCount > 0 ? 'has-unread' : ''}">
                            <div class="info">
                                <div class="conv-title">${titulo}</div>
                                <div class="last-msg">Toca para abrir</div>
                            </div>
                            <div class="meta">
                                ${unreadBadge}
                                <button class="delete-btn" title="Eliminar">üóëÔ∏è</button>
                            </div>
                        </div>`;

                    li.querySelector('.info').onclick = () => abrirConversacion(c.id);

                    li.querySelector('.delete-btn').onclick = (e) => {
                        e.stopPropagation();
                        eliminarConversacion(c.id);
                    };

                    ul.appendChild(li);
                });

                actualizarContadorGlobal(totalUnread);

                if (!currentConvId && data.length > 0) abrirConversacion(data[0].id);
            }).catch(function(e){
                console.error('Error:', e);
                $lista().innerHTML = '<li class="empty-state">Error al cargar</li>';
            });
        }

        function actualizarContadorGlobal(count) {
            const badge = $totalUnread();
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = 'inline-flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function setConvTitleFromList(id){
            const li = Array.from($lista().children).find(el => Number(el.dataset.id) === id);
            const t  = li?.querySelector('.conv-title')?.textContent || 'Chat';
            $title().textContent = t;
        }

        function abrirConversacion(id){
            if (currentConvId === id) return;

            const items = $lista().children;
            for (let i=0; i<items.length; i++){
                items[i].classList.toggle('is-active', Number(items[i].dataset.id) === id);
            }

            currentConvId = id;
            setConvTitleFromList(id);

            // Cerrar b√∫squeda al cambiar de conversaci√≥n
            cerrarBusqueda();

            if (currentSubscription){
                try { currentSubscription.unsubscribe(); } catch(e){}
                currentSubscription = null;
            }

            fetchJSON('/api/chat/conversaciones/' + id + '/mensajes').then(function(page){
                const mensajes = (page.content || []).slice().reverse();
                const cont = $msgs();
                cont.innerHTML = '';

                if (!mensajes.length){
                    renderEmptyMensajes('Env√≠a el primer mensaje');
                } else {
                    mensajes.forEach(function(m){
                        const esMio = (m.remitente === yo);
                        cont.appendChild(crearBurbuja(m.remitente, m.contenido, esMio, m.leido, m.creadoEn));
                    });
                    cont.scrollTop = cont.scrollHeight;
                }

                if (stomp && stomp.connected){
                    suscribirA(id);
                }

                fetch(`/api/chat/conversaciones/${id}/marcar-leida`, { method: 'POST' })
                    .then(() => cargarConversaciones())
                    .catch(e => console.warn('No se marc√≥ como le√≠da', e));

                document.body.classList.add('chat-open');
            }).catch(function(e){
                console.error(e);
                renderEmptyMensajes('Error al cargar mensajes');
            });
        }

        function suscribirA(convId){
            if (currentSubscription){
                try { currentSubscription.unsubscribe(); } catch(e){}
            }

            currentSubscription = stomp.subscribe('/topic/conversaciones.' + convId, function(frame){
                const m = JSON.parse(frame.body);

                if (m.remitenteNombre === yo) return;

                const div = crearBurbuja(m.remitenteNombre, m.contenido, false, false, m.creadoEn);
                $msgs().appendChild(div);
                div.scrollIntoView({ behavior: 'smooth' });

                reproducirSonido();
            });
        }

        function crearBurbuja(remitente, texto, esMio, leido, timestamp){
            const div = document.createElement('div');
            div.className = 'msg' + (esMio ? ' me' : '');
            div.dataset.content = texto; // Para b√∫squeda

            const time = timestamp ? new Date(timestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'}) : '';
            const leidoIndicator = esMio && leido ? '<span class="read-indicator">‚úì‚úì</span>' : '';

            div.innerHTML = esMio
                ? escapeHTML(texto) + leidoIndicator + (time ? '<span class="msg-time">' + time + '</span>' : '')
                : '<strong>' + escapeHTML(remitente) + '</strong><br>' + escapeHTML(texto) + (time ? '<span class="msg-time">' + time + '</span>' : '');

            return div;
        }

        document.getElementById('form-msg').addEventListener('submit', function(e){
            e.preventDefault();
            const txt = document.getElementById('txt');
            const contenido = txt.value.trim();
            if (!contenido || !currentConvId) return;

            if (!stomp || !stomp.connected){
                alert('Sin conexi√≥n. Reconectando...');
                conectarChat();
                return;
            }

            const payload = JSON.stringify({ convId: currentConvId, texto: contenido });
            stomp.send('/app/chat.send', {}, payload);

            txt.value = '';
        });

        document.getElementById('txt').addEventListener('keydown', function(e){
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('form-msg').dispatchEvent(new Event('submit', {cancelable: true}));
            }
        });

        document.getElementById('btn-crear').addEventListener('click', function(){
            const user = document.getElementById('nuevo-usuario').value.trim();
            if (!user) {
                alert('Introduce un username');
                return;
            }

            fetchJSON('/api/chat/conversaciones/directa?username=' + encodeURIComponent(user), { method: 'POST' })
                .then(() => {
                    document.getElementById('nuevo-usuario').value = '';
                    return cargarConversaciones();
                })
                .then(() => alert('Conversaci√≥n creada'))
                .catch(e => {
                    console.error(e);
                    alert('Error: ' + e);
                });
        });

        document.querySelector('.back-btn')?.addEventListener('click', () => {
            document.body.classList.remove('chat-open');
        });

        function reproducirSonido() {
            try {
                const audio = new Audio('/sounds/notification.mp3');
                audio.volume = 0.3;
                audio.play().catch(() => {});
            } catch(e) {}
        }

        // ===== FUNCIONALIDAD B√öSQUEDA =====

        document.getElementById('search-btn').addEventListener('click', function(){
            if (!currentConvId) {
                alert('Abre una conversaci√≥n primero');
                return;
            }

            const searchBar = $searchBar();
            searchBar.classList.toggle('active');

            if (searchBar.classList.contains('active')) {
                $searchInput().focus();
            } else {
                cerrarBusqueda();
            }
        });

        document.getElementById('search-input').addEventListener('input', function(e){
            const query = e.target.value.trim().toLowerCase();

            if (!query) {
                limpiarBusqueda();
                return;
            }

            buscarEnMensajes(query);
        });

        function buscarEnMensajes(query) {
            const mensajes = Array.from($msgs().querySelectorAll('.msg'));
            searchResults = [];

            // Limpiar highlights previos
            mensajes.forEach(msg => {
                const content = msg.dataset.content || '';
                const remitente = msg.querySelector('strong')?.textContent || '';
                msg.innerHTML = msg.classList.contains('me')
                    ? escapeHTML(content)
                    : '<strong>' + escapeHTML(remitente) + '</strong><br>' + escapeHTML(content);
            });

            // Buscar y resaltar
            mensajes.forEach((msg, index) => {
                const content = msg.dataset.content || '';
                if (content.toLowerCase().includes(query)) {
                    searchResults.push({ element: msg, index: index });

                    // Resaltar coincidencias
                    const regex = new RegExp('(' + query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
                    const highlighted = content.replace(regex, '<span class="highlight">$1</span>');

                    if (msg.classList.contains('me')) {
                        msg.innerHTML = highlighted;
                    } else {
                        const remitente = msg.querySelector('strong')?.textContent || '';
                        msg.innerHTML = '<strong>' + escapeHTML(remitente) + '</strong><br>' + highlighted;
                    }
                }
            });

            // Actualizar UI
            $searchResults().textContent = searchResults.length + ' resultado' + (searchResults.length !== 1 ? 's' : '');
            document.getElementById('prev-result').disabled = searchResults.length === 0;
            document.getElementById('next-result').disabled = searchResults.length === 0;

            if (searchResults.length > 0) {
                currentSearchIndex = 0;
                navegarAResultado(0);
            } else {
                currentSearchIndex = -1;
            }
        }

        function navegarAResultado(index) {
            if (searchResults.length === 0) return;

            // Limpiar highlight activo
            document.querySelectorAll('.highlight.active').forEach(el => {
                el.classList.remove('active');
            });

            // Activar nuevo highlight
            const result = searchResults[index];
            const highlights = result.element.querySelectorAll('.highlight');
            if (highlights.length > 0) {
                highlights[0].classList.add('active');
            }

            // Scroll al resultado
            result.element.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Actualizar contador
            $searchResults().textContent = `${index + 1} de ${searchResults.length}`;
        }

        document.getElementById('prev-result').addEventListener('click', function(){
            if (searchResults.length === 0) return;
            currentSearchIndex = (currentSearchIndex - 1 + searchResults.length) % searchResults.length;
            navegarAResultado(currentSearchIndex);
        });

        document.getElementById('next-result').addEventListener('click', function(){
            if (searchResults.length === 0) return;
            currentSearchIndex = (currentSearchIndex + 1) % searchResults.length;
            navegarAResultado(currentSearchIndex);
        });

        document.getElementById('close-search').addEventListener('click', function(){
            cerrarBusqueda();
        });

        function cerrarBusqueda() {
            $searchBar().classList.remove('active');
            $searchInput().value = '';
            limpiarBusqueda();
        }

        function limpiarBusqueda() {
            // Limpiar highlights
            const mensajes = Array.from($msgs().querySelectorAll('.msg'));
            mensajes.forEach(msg => {
                const content = msg.dataset.content || '';
                const remitente = msg.querySelector('strong')?.textContent || '';
                msg.innerHTML = msg.classList.contains('me')
                    ? escapeHTML(content)
                    : '<strong>' + escapeHTML(remitente) + '</strong><br>' + escapeHTML(content);
            });

            searchResults = [];
            currentSearchIndex = -1;
            $searchResults().textContent = '0 resultados';
            document.getElementById('prev-result').disabled = true;
            document.getElementById('next-result').disabled = true;
        }

        // ===== FUNCIONALIDAD OPCIONES =====

        document.getElementById('options-btn').addEventListener('click', function(e){
            e.stopPropagation();
            if (!currentConvId) {
                alert('Abre una conversaci√≥n primero');
                return;
            }
            $optionsMenu().classList.toggle('active');
        });

        // Cerrar men√∫ al hacer clic fuera
        document.addEventListener('click', function(e){
            if (!e.target.closest('#options-btn') && !e.target.closest('#options-menu')) {
                $optionsMenu().classList.remove('active');
            }
        });

        // ‚úÖ 1. SILENCIAR CONVERSACI√ìN
        document.getElementById('mute-conv').addEventListener('click', function(){
            if (!currentConvId) return;

            if (confirm('¬øSilenciar esta conversaci√≥n?\n\nNo recibir√°s notificaciones, pero los mensajes seguir√°n llegando.')) {
                fetch(`/api/chat/conversaciones/${currentConvId}/silenciar`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ muted: true })
                })
                    .then(resp => {
                        if (!resp.ok) throw new Error('Error al silenciar');
                        alert('‚úÖ Conversaci√≥n silenciada');
                        cargarConversaciones();
                    })
                    .catch(err => {
                        console.error('Error:', err);
                        alert('‚ùå No se pudo silenciar la conversaci√≥n');
                    });
            }

            $optionsMenu().classList.remove('active');
        });

        // ‚úÖ 2. ARCHIVAR CONVERSACI√ìN
        document.getElementById('archive-conv').addEventListener('click', function(){
            if (!currentConvId) return;

            if (confirm('¬øArchivar esta conversaci√≥n?\n\nSe mover√° a la secci√≥n de archivados.')) {
                fetch(`/api/chat/conversaciones/${currentConvId}/archivar`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ archived: true })
                })
                    .then(resp => {
                        if (!resp.ok) throw new Error('Error al archivar');
                        alert('‚úÖ Conversaci√≥n archivada');
                        currentConvId = null;
                        renderEmptyMensajes('Selecciona una conversaci√≥n');
                        cargarConversaciones();
                    })
                    .catch(err => {
                        console.error('Error:', err);
                        alert('‚ùå No se pudo archivar la conversaci√≥n');
                    });
            }

            $optionsMenu().classList.remove('active');
        });

        // ‚úÖ 3. VER DETALLES
        document.getElementById('details-conv').addEventListener('click', function(){
            if (!currentConvId) return;

            fetchJSON(`/api/chat/conversaciones/${currentConvId}/detalles`)
                .then(detalles => {
                    const info =
                        'üìã DETALLES DE LA CONVERSACI√ìN\n\n' +
                        'ID: ' + detalles.id + '\n' +
                        'Tipo: ' + (detalles.tipo || 'DIRECT') + '\n' +
                        'Servicio: ' + (detalles.servicio || 'CHAT') + '\n\n' +
                        'üë• Miembros (' + detalles.miembros.length + '):\n' +
                        detalles.miembros.map(m => '  ‚Ä¢ ' + m).join('\n') + '\n\n' +
                        'üí¨ Total mensajes: ' + detalles.totalMensajes + '\n' +
                        'üì¨ No le√≠dos: ' + detalles.noLeidos + '\n\n' +
                        'üîï Silenciada: ' + (detalles.muted ? 'S√≠' : 'No') + '\n' +
                        'üìÅ Archivada: ' + (detalles.archived ? 'S√≠' : 'No') + '\n\n' +
                        'üìÖ Creada: ' + new Date(detalles.creadoEn).toLocaleString('es-ES');

                    alert(info);
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('‚ùå No se pudieron cargar los detalles');
                });

            $optionsMenu().classList.remove('active');
        });

        // ‚úÖ 4. LIMPIAR HISTORIAL
        document.getElementById('clear-history').addEventListener('click', function(){
            if (!currentConvId) return;

            if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres limpiar el historial?\n\n' +
                'Se eliminar√°n TODOS los mensajes de esta conversaci√≥n.\n' +
                'Esta acci√≥n NO se puede deshacer.')) {

                fetch(`/api/chat/conversaciones/${currentConvId}/historial`, {
                    method: 'DELETE'
                })
                    .then(resp => {
                        if (!resp.ok) throw new Error('Error al limpiar historial');
                        alert('‚úÖ Historial limpiado');
                        renderEmptyMensajes('Env√≠a el primer mensaje');
                    })
                    .catch(err => {
                        console.error('Error:', err);
                        alert('‚ùå No se pudo limpiar el historial');
                    });
            }

            $optionsMenu().classList.remove('active');
        });

        // ‚úÖ 5. ELIMINAR CONVERSACI√ìN (ya estaba funcional)
        document.getElementById('delete-conv').addEventListener('click', function(){
            if (!currentConvId) return;
            eliminarConversacion(currentConvId);
            $optionsMenu().classList.remove('active');
        });

        function eliminarConversacion(id) {
            if (confirm('¬øEliminar esta conversaci√≥n?')) {
                fetch(`/api/chat/conversaciones/${id}`, { method: 'DELETE' })
                    .then(() => {
                        if (currentConvId === id) {
                            currentConvId = null;
                            renderEmptyMensajes('Selecciona una conversaci√≥n');
                        }
                        cargarConversaciones();
                    })
                    .catch(err => {
                        console.error('Error:', err);
                        alert('No se pudo eliminar la conversaci√≥n');
                    });
            }
        }

        // ===== INIT =====

        conectarChat();
        cargarConversaciones();

        setInterval(() => {
            fetchJSON('/api/chat/no-leidos/total')
                .then(data => actualizarContadorGlobal(data.total))
                .catch(() => {});
        }, 30000);
    }
</script>
</body>
</html>