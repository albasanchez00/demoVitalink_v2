<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8" />
    <title>Nuevo tratamiento (Médico)</title>
    <link rel="stylesheet" href="/css/style2.css" />
    <script src="/js/darkTheme.js" defer></script>
    <script src="/js/sccript.js" defer></script>
</head>
<body>
<section class="contenedor">
    <div th:replace="~{fragments/header :: header}"></div>

    <main id="main-tratamientos">
        <section class="section-tratamientos">
            <h2>
                <span th:if="${usuario != null}"
                  th:text="${'Nuevo tratamiento para: ' + usuario.username}">
                  Añadir tratamiento
                </span>
            </h2>

            <form th:action="@{/medico/guardar}" method="post" th:object="${tratamiento}" class="form-trat">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <!-- A) con usuario preasignado -->
                <input th:if="${usuario != null}" type="hidden" name="id_usuario" th:value="${usuario.id_usuario}" />

                <!-- B) sin usuario preasignado -->
                <div th:if="${usuario == null}" class="form-row">
                    <label for="id_usuario">Usuario</label>
                    <select id="id_usuario" name="id_usuario" required>
                        <option>Selecciona un usuario</option>
                        <option th:each="u : ${usuarios}"
                                th:value="${u.id_usuario}"
                                th:text="${u.username}">
                        </option>
                    </select>
                </div>

                <div class="form-grid">
                    <div class="form-row">
                        <label for="nombre_tratamiento">Medicamento</label>
                        <input id="nombre_tratamiento" th:field="*{nombre_tratamiento}" required />
                    </div>

                    <div class="form-row">
                        <label for="formula">Forma farmacéutica</label>
                        <select id="formula" th:field="*{formula}">
                            <option value=""></option>
                            <option value="tableta">Tableta</option>
                            <option value="jarabe">Jarabe</option>
                            <option value="inyectable">Inyectable</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <label for="dosis">Dosis</label>
                        <input id="dosis" th:field="*{dosis}" placeholder="p.ej. 500 mg" />
                    </div>

                    <div class="form-row">
                        <label for="frecuencia">Frecuencia</label>
                        <input id="frecuencia" th:field="*{frecuencia}" placeholder="p.ej. cada 8 horas" />
                    </div>

                    <div class="form-row">
                        <label for="fecha_inicio">Fecha inicio</label>
                        <input type="date" id="fecha_inicio" th:field="*{fecha_inicio}" required />
                    </div>

                    <div class="form-row">
                        <label for="fecha_fin">Fecha fin</label>
                        <input type="date" id="fecha_fin" th:field="*{fecha_fin}" />
                    </div>

                    <div class="form-row">
                        <label for="toma_alimentos">Con alimentos</label>
                        <select id="toma_alimentos" th:field="*{toma_alimentos}">
                            <option th:value="true">Sí</option>
                            <option th:value="false">No</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <label for="estado_tratamiento">Estado</label>
                        <select id="estado_tratamiento" th:field="*{estado_tratamiento}">
                            <option value=""></option>
                            <option value="Activo">Activo</option>
                            <option value="Pausado">Pausado</option>
                            <option value="Finalizado">Finalizado</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <label for="sintomas">Síntomas relacionados</label>
                        <input id="sintomas" th:field="*{sintomas}" placeholder="p.ej. dolor, fiebre..." />
                    </div>

                    <div class="form-row">
                        <label for="observaciones">Observaciones</label>
                        <textarea id="observaciones" th:field="*{observaciones}" rows="3"></textarea>
                    </div>
                    <div class="rec-actions" style="margin-top:12px;display:flex;gap:.5rem;flex-wrap:wrap;">
                        <button type="submit">Guardar tratamiento</button>

                        <!-- Volver según haya usuario preasignado o no -->
                        <a th:if="${usuario != null}"
                           th:href="@{/medico/tratamientos(id_usuario=${usuario.id_usuario})}"
                           class="btn-sec">Volver</a>

                        <a th:if="${usuario == null}"
                           th:href="@{/medico/tratamientos}"
                           class="btn-sec">Volver</a>
                    </div>
                </div>
            </form>
        </section>
    </main>

    <div th:replace="~{fragments/footer :: footer}"></div>
</section>
</body>
</html>