<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8" />
    <title>Nuevo/Editar tratamiento (Médico)</title>
    <link rel="stylesheet" href="/css/style2.css" />
    <script src="/js/darkTheme.js" defer></script>
    <script src="/js/script.js" defer></script> <!-- ojo al typo sccript.js -->
    <link rel="shortcut icon" th:href="@{/media/favicon_IA_Medica.ico}" type="image/x-icon">
</head>
<body>
<section class="contenedor">
    <div th:replace="~{fragments/header :: header}"></div>

    <main id="main-tratamientos">
        <!-- Ponemos th:object aquí para poder usar *{...} en los campos -->
        <section class="section-tratamientos" th:object="${tratamiento}">

            <h2>
                <!-- SOLO ${} aquí, sin *{} -->
                <span th:if="${tratamiento == null or tratamiento.id_tratamiento == null}"
                      th:text="${'Nuevo tratamiento para: ' + (usuario != null ? usuario.username
                       : (tratamiento != null and tratamiento.usuario != null ? tratamiento.usuario.username : '—'))}">
          Nuevo tratamiento
        </span>

                <span th:if="${tratamiento != null and tratamiento.id_tratamiento != null}"
                      th:text="${'Editar tratamiento de: ' + (usuario != null ? usuario.username
                       : (tratamiento.usuario != null ? tratamiento.usuario.username : '—'))}">
          Editar tratamiento
        </span>
            </h2>

            <!-- TERNARIO en th:action, sin mezclar *{} -->
            <form th:action="${tratamiento != null and tratamiento.id_tratamiento != null}
                        ? @{/medico/actualizar}
                        : @{/medico/guardar}"
                  method="post" class="form-trat">

                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <!-- Id del tratamiento (solo edición) -->
                <input th:if="*{id_tratamiento != null}" type="hidden" th:field="*{id_tratamiento}"/>

                <!-- Usuario fijado (viene en el modelo) -->
                <input th:if="${usuario != null}" type="hidden" name="id_usuario" th:value="${usuario.id_usuario}"/>

                <!-- Selector de usuario solo si no viene fijado -->
                <div th:if="${usuario == null}" class="form-row">
                    <label for="id_usuario">Usuario</label>
                    <select id="id_usuario" name="id_usuario" required>
                        <option value="">Selecciona un usuario</option>
                        <option th:each="u : ${usuarios}"
                                th:value="${u.id_usuario}"
                                th:text="${u.username}">
                        </option>
                    </select>
                </div>

                <div class="form-grid">
                    <div class="form-row">
                        <label for="nombre_tratamiento">Medicamento</label>
                        <input id="nombre_tratamiento" th:field="*{nombre_tratamiento}" required />
                    </div>

                    <div class="form-row">
                        <label for="formula">Forma farmacéutica</label>
                        <select id="formula" th:field="*{formula}">
                            <option value=""></option>
                            <option value="tableta">Tableta</option>
                            <option value="jarabe">Jarabe</option>
                            <option value="inyectable">Inyectable</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <label for="dosis">Dosis</label>
                        <input id="dosis" th:field="*{dosis}" placeholder="p.ej. 500 mg" />
                    </div>

                    <div class="form-row">
                        <label for="frecuencia">Frecuencia</label>
                        <input id="frecuencia" th:field="*{frecuencia}" placeholder="p.ej. cada 8 horas" />
                    </div>

                    <div class="form-row">
                        <label for="fecha_inicio">Fecha inicio</label>
                        <input type="date" id="fecha_inicio" th:field="*{fecha_inicio}" />
                    </div>

                    <div class="form-row">
                        <label for="fecha_fin">Fecha fin</label>
                        <input type="date" id="fecha_fin" th:field="*{fecha_fin}" />
                    </div>


                    <div class="form-row">
                        <label for="toma_alimentos">Con alimentos</label>
                        <select id="toma_alimentos" th:field="*{toma_alimentos}">
                            <option th:value="true">Sí</option>
                            <option th:value="false">No</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <label for="estado_tratamiento">Estado</label>
                        <select id="estado_tratamiento" th:field="*{estado_tratamiento}">
                            <option value=""></option>
                            <option value="Activo">Activo</option>
                            <option value="Pausado">Pausado</option>
                            <option value="Finalizado">Finalizado</option>
                        </select>
                    </div>

                    <div class="form-row" style="grid-column:1 / -1;">
                        <label for="sintomas">Síntomas relacionados</label>
                        <input id="sintomas" th:field="*{sintomas}" placeholder="p.ej. dolor, fiebre..." />
                    </div>

                    <div class="form-row" style="grid-column:1 / -1;">
                        <label for="observaciones">Observaciones</label>
                        <textarea id="observaciones" th:field="*{observaciones}" rows="3"></textarea>
                    </div>
                </div>

                <div class="rec-actions" style="margin-top:12px;display:flex;gap:.5rem;flex-wrap:wrap;">
                    <button type="submit"
                            th:text="${tratamiento != null and tratamiento.id_tratamiento != null
                           ? 'Guardar cambios' : 'Guardar tratamiento'}">
                        Guardar
                    </button>

                    <a th:if="${usuario != null}"
                       th:href="@{/medico/tratamientos(id_usuario=${usuario.id_usuario})}"
                       class="btn-sec">Volver</a>
                    <a th:if="${usuario == null}"
                       th:href="@{/medico/tratamientos}"
                       class="btn-sec">Volver</a>
                </div>
            </form>
        </section>
    </main>

    <div th:replace="~{fragments/footer :: footer}"></div>
</section>
</body>
</html>